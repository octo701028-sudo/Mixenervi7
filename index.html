
<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Enervi7 PWA v4.1</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#6a00ff">
<style>
  :root { --bg:#0f0b1e; --panel:#141126; --accent:#6a00ff; --text:#ece8ff; --muted:#bdb6df; }
  body{margin:0;background:radial-gradient(1100px 520px at 80% 0%, #6a00ff18, transparent),var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto}
  header{padding:18px 16px;background:linear-gradient(90deg,#6a00ff,#8b5cf6);position:sticky;top:0;z-index:2}
  h1{margin:0;font-size:24px}
  .wrap{max-width:980px;margin:18px auto;padding:0 16px}
  .card{background:var(--panel);border:1px solid #ffffff17;border-radius:14px;padding:16px;margin:14px 0;box-shadow:0 10px 30px #00000040}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px} @media(max-width:760px){ .row{grid-template-columns:1fr} }
  .q{margin:8px 0 14px} .q label{display:block;margin-bottom:6px;color:var(--muted)}
  input[type=range]{width:100%}
  .btn{background:var(--accent);border:none;color:white;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
  canvas{width:100%;max-width:560px;height:auto;display:block;margin:auto;border:1px solid #ffffff1a;border-radius:8px;background:#00000014}
  .chip{background:#6a00ff20;border:1px solid #6a00ff60;border-radius:999px;padding:4px 10px;font-size:12px;margin-right:6px}
  .streak{background:#00c85322;border:1px solid #00c85366}
  .badge{display:inline-block;border:1px solid #ffffff24;border-radius:999px;padding:4px 10px;margin:4px 6px 0 0;color:#fff;background:#ffffff14;font-size:12px}
  .pill{border:1px solid #ffffff1f;border-radius:10px;padding:10px;margin-top:8px}
  .flag{display:inline-block;border-radius:6px;padding:2px 8px;margin-left:8px;font-size:12px}
  .flag.low{background:#ff3b3080} .flag.mid{background:#f1c40f66} .flag.high{background:#2ecc7180}
  .hint{color:var(--muted);font-size:13px}
</style>
</head>
<body>
<header>
  <h1>Enervi7 PWAï¼ˆv4.1ï¼‰ <span id="streak" class="chip streak">é€£çºŒ 0 å¤©</span> <span class="chip">å‘¢å–ƒç¥è«­</span><span class="chip">ä»Šæ—¥ç²¾æ²¹</span></h1>
  <div class="hint">é‡è¡¨ï¼š0 = å®Œå…¨ä¸ç¬¦åˆ ï¼ 10 = éå¸¸ç¬¦åˆ</div>
</header>
<div class="wrap">
  <section class="card" id="quiz">
    <h2>ğŸ§­ 14 é¡Œé‡è¡¨</h2>
    <div class="row" id="qwrap"></div>
    <button class="btn" id="gen">ç”Ÿæˆçµæœ</button>
  </section>
  <section class="card">
    <h2>ğŸ“Š èƒ½é‡é›·é”åœ–</h2>
    <canvas id="radar" width="560" height="420"></canvas>
    <div id="topkeys" class="hint"></div>
  </section>
  <section class="card">
    <h2>ğŸ´ ä»Šæ—¥æŒ‡å¼•èˆ‡ç²¾æ²¹</h2>
    <div id="cards"></div>
    <div class="pill" id="dailyOil">ä»Šæ—¥å»ºè­°ç²¾æ²¹ï¼šâ€”</div>
  </section>
  <section class="card">
    <h2>ğŸŒ¬ï¸ å‘¢å–ƒç¥è«­ï¼ˆæŠ½å¡ï¼‰</h2>
    <button class="btn" id="draw">æŠ½å¡</button>
    <div id="oracleCard" class="pill"></div>
  </section>
  <section class="card">
    <h2>ğŸŒˆ ä¸ƒéšè³‡è¨Šå¡</h2>
    <div id="phases"></div>
  </section>
</div>
<script>
const QUESTIONS = [
 {phase:'ç™½ï½œèƒ½é‡è¦ºçŸ¥', text:'æˆ‘èƒ½æ¸…æ¥šè¦ºå¯Ÿè‡ªå·±æ­¤åˆ»çš„èº«å¿ƒç‹€æ…‹ã€‚'},
 {phase:'ç™½ï½œèƒ½é‡è¦ºçŸ¥', text:'æˆ‘èƒ½åœ¨æ··äº‚æ™‚ï¼Œè¿…é€ŸæŠŠæ³¨æ„åŠ›å¸¶å›ç•¶ä¸‹ã€‚'},
 {phase:'è—ï½œç©©å®šèˆ‡æ·¨åŒ–', text:'é¢å°å£“åŠ›æˆ–è¡çªæ™‚ï¼Œæˆ‘èƒ½ä¿æŒå†·éœä¸å¤±è¡¡ã€‚'},
 {phase:'è—ï½œç©©å®šèˆ‡æ·¨åŒ–', text:'æˆ‘èƒ½æœ‰æ•ˆåœ°é‡‹æ”¾ç´¯ç©çš„è² é¢æƒ…ç·’èˆ‡é›œå¿µã€‚'},
 {phase:'æ©™ï½œèƒ½é‡æµå‹•', text:'æˆ‘å¸¸æ„Ÿè¦ºéˆæ„Ÿï¼æƒ…æ„Ÿåœ¨é«”å…§è‡ªç„¶æµå‹•ã€‚'},
 {phase:'æ©™ï½œèƒ½é‡æµå‹•', text:'æˆ‘èƒ½é †å‹¢èª¿æ•´æ­¥èª¿ï¼Œä¸åƒµç¡¬æˆ–å¡ä½ã€‚'},
 {phase:'é»ƒï½œå…§åœ¨åŠ›é‡', text:'åšæ±ºå®šæ™‚ï¼Œæˆ‘èƒ½å …å®šåœ°é¸æ“‡å°è‡ªå·±çœŸçš„å¥½çš„äº‹ã€‚'},
 {phase:'é»ƒï½œå…§åœ¨åŠ›é‡', text:'é‡åˆ°æŒ‘æˆ°ï¼Œæˆ‘ä»èƒ½ç›¸ä¿¡è‡ªå·±ä¸¦å¾€å‰ä¸€æ­¥ã€‚'},
 {phase:'ç¶ ï½œå…±æŒ¯èˆ‡é€£çµ', text:'æˆ‘èƒ½çœŸèª è¡¨é”ï¼Œä¹Ÿæ¨‚æ–¼å‚¾è½ä»–äººã€‚'},
 {phase:'ç¶ ï½œå…±æŒ¯èˆ‡é€£çµ', text:'æˆ‘èƒ½æ„Ÿåˆ°è‡ªå·±èˆ‡ä»–äººã€èˆ‡ä¸–ç•Œæ˜¯é€£çµçš„ã€‚'},
 {phase:'é›è—ï½œæ„è­˜æ“´å±•', text:'æˆ‘ä¿¡ä»»ç›´è¦ºï¼Œä¸”èƒ½å¾ä¸­ç²å¾—æœ‰ç”¨çš„æŒ‡å¼•ã€‚'},
 {phase:'é›è—ï½œæ„è­˜æ“´å±•', text:'æˆ‘èƒ½å¾æ—¥å¸¸äº‹ä»¶çœ‹è¦‹æ›´æ·±çš„æ´è¦‹èˆ‡æ„ç¾©ã€‚'},
 {phase:'ç´«ï½œéˆé­‚æ•´åˆ', text:'æˆ‘èƒ½æŠŠéå»çš„ç¶“é©—æ•´åˆæˆåŠ›é‡ï¼Œè€Œä¸æ˜¯æ·é–ã€‚'},
 {phase:'ç´«ï½œéˆé­‚æ•´åˆ', text:'æˆ‘å¸¸æ„Ÿåˆ°è‡ªå·±å®Œæ•´ã€å°ç”Ÿå‘½æ–¹å‘è¸å¯¦å®‰å¿ƒã€‚'}
];
const PHASES = ['ç™½ï½œèƒ½é‡è¦ºçŸ¥','è—ï½œç©©å®šèˆ‡æ·¨åŒ–','æ©™ï½œèƒ½é‡æµå‹•','é»ƒï½œå…§åœ¨åŠ›é‡','ç¶ ï½œå…±æŒ¯èˆ‡é€£çµ','é›è—ï½œæ„è­˜æ“´å±•','ç´«ï½œéˆé­‚æ•´åˆ'];

const PHASE_INFO = {
 'ç™½ï½œèƒ½é‡è¦ºçŸ¥': {key:'è¦ºçŸ¥ã€æ¸…æ˜ã€é¢å°ç•¶ä¸‹', actions:['å¯«ä¸‰å¥ã€Œæ­¤åˆ»æˆ‘çœŸå¯¦çš„æ„Ÿå—æ˜¯â€¦ã€','3 åˆ†é˜è…¹å¼å‘¼å¸ï¼ˆ4-4-6ï¼‰','åˆ—å‡º 1 å€‹å¿µé ­ï¼šæ˜¯äº‹å¯¦é‚„æ˜¯è§£è®€ï¼Ÿ'], yl:['Clarity','Awaken'], single:['ä¹³é¦™','å°¤åŠ åˆ©'], blocks:['å®¹æ˜“åˆ†å¿ƒ','è³‡è¨Šéè¼‰']},
 'è—ï½œç©©å®šèˆ‡æ·¨åŒ–': {key:'ç©©å®šã€é‡‹æ”¾ã€ç•Œç·š', actions:['å¯«ä¸‹ 1 ä»¶å¯æ§/ä¸å¯æ§','èµ° 10 åˆ†é˜','ç¡å‰ 3 ä»¶æ„Ÿè¬'], yl:['Stress Away','Peace & Calming','Grounding'], single:['é¼ å°¾è‰','è–„è·'], blocks:['è¢«å£“åŠ›åæ²’','æƒ…ç·’å›¤ç©']},
 'æ©™ï½œèƒ½é‡æµå‹•': {key:'æµå‹•ã€å‰µé€ ã€æ„Ÿå—', actions:['5 åˆ†é˜è‡ªç”±æ›¸å¯«','å®‰æ’ 1 ä»¶å°ç©æ¨‚','æŠŠ Toâ€‘do åˆ‡æˆ 10 åˆ†é˜'], yl:['Joy','Abundance','Aroma Siez'], single:['ç”œæ©™','ä¾è˜­'], blocks:['æƒ…ç·’å¡ä½','æ‹–å»¶']},
 'é»ƒï½œå…§åœ¨åŠ›é‡': {key:'è‡ªä¿¡ã€é‚Šç•Œã€è¡Œå‹•', actions:['è¨­å®š 1 ä»¶ MIT','ç·´ç¿’èªªä¸€æ¬¡ã€Œä¸ã€','å®Œæˆå¾Œå…¬é–‹å›å ±'], yl:['Valor','Believe','Enâ€‘Râ€‘Gâ€‘E'], single:['æª¸æª¬è‰','è¿·è¿­é¦™'], blocks:['ä¾è³´ä»–äºº','å®³æ€•å¤±æ•—']},
 'ç¶ ï½œå…±æŒ¯èˆ‡é€£çµ': {key:'çœŸèª ã€å…±é³´ã€é—œä¿‚', actions:['å‚¾è½ 1 äºº 3 åˆ†é˜','å‚³ä¸€å‰‡è¬è¬è¨Šæ¯','å°è‡ªå·±åšä¸€ä»¶æº«æŸ”çš„äº‹'], yl:['Harmony','Acceptance','Christmas Spirit'], single:['ç«ç‘°è‰','å¤©ç«ºè‘µ'], blocks:['å®³æ€•è¢«æ‹’çµ•','ä»˜å‡ºéé‡']},
 'é›è—ï½œæ„è­˜æ“´å±•': {key:'ç›´è¦ºã€æ´è¦‹ã€å†¥æƒ³', actions:['éœå¿ƒï¼šå¸4åœ4å‘¼6','å¯«ä¸‹ä¸€å¥ç›´è¦ºè¨Šæ¯','å›é¡§ä»Šæ—¥å•Ÿç™¼'], yl:['Dream Catcher','Forgiveness','Highest Potential'], single:['è–°è¡£è‰','ä¹³é¦™'], blocks:['ä¸ä¿¡ä»»ç›´è¦º','éåº¦ç†æ€§']},
 'ç´«ï½œéˆé­‚æ•´åˆ': {key:'æ•´åˆã€å…¨è²Œã€è‡£æœ', actions:['æŠŠéå»å¯«æˆåŠ›é‡æ•…äº‹','å¯«ä¸‹ä¸€ä»¶æˆ‘é¸æ“‡å…è¨±çš„äº‹','ä»Šæ™šæ—©ç¡ 30 åˆ†é˜'], yl:['White Angelica','Sacred Mountain','Transformation'], single:['å»£è—¿é¦™','å²©è˜­è‰'], blocks:['çœ‹ä¸è¦‹æ–¹å‘','ç¼ºä¹æ•´åˆæ„Ÿ']}
};

// Build questions with number labels
const qwrap = document.getElementById('qwrap');
QUESTIONS.forEach((q,i)=>{
  const id = 'q'+i;
  const div = document.createElement('div'); div.className='q card';
  div.innerHTML = '<label>'+ (i+1) +'. <b>'+q.phase+'</b>ï½œ'+q.text+' <span id="'+id+'_val" class="badge">5</span></label>' +
                  '<input type="range" min="0" max="10" step="1" value="5" id="'+id+'">' +
                  '<div class="hint">0 = å®Œå…¨ä¸ç¬¦åˆ ï¼ 10 = éå¸¸ç¬¦åˆ</div>';
  qwrap.appendChild(div);
  const slider = div.querySelector('#'+id);
  const disp = div.querySelector('#'+id+'_val');
  slider.addEventListener('input', ()=> disp.textContent = slider.value);
});

function computeScores(){
  const vals = {}; let idx=0;
  PHASES.forEach(p=>{ const a=+document.getElementById('q'+idx++).value; const b=+document.getElementById('q'+idx++).value; vals[p]=(a+b)/2; });
  return vals;
}

function drawRadar(scores){
  const canvas = document.getElementById('radar'), ctx = canvas.getContext('2d');
  const W=canvas.width,H=canvas.height,cx=W/2,cy=H/2+10,R=Math.min(W,H)/2-40; ctx.clearRect(0,0,W,H);
  ctx.strokeStyle='#ffffff22'; for(let r=R;r>R/5;r-=R/5){ ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.stroke(); }
  for(let i=0;i<PHASES.length;i++){ const ang=-Math.PI/2+i*(Math.PI*2/PHASES.length); ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx+Math.cos(ang)*R, cy+Math.sin(ang)*R); ctx.stroke(); }
  ctx.beginPath();
  for(let i=0;i<PHASES.length;i++){ const ang=-Math.PI/2+i*(Math.PI*2/PHASES.length); const v=scores[PHASES[i]]/10; const x=cx+Math.cos(ang)*R*v, y=cy+Math.sin(ang)*R*v; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }
  ctx.closePath(); ctx.fillStyle='#6a00ff55'; ctx.strokeStyle='#6a00ff'; ctx.lineWidth=2; ctx.fill(); ctx.stroke();
}

function flag(val){ if(val<=3) return '<span class="flag low">è£œçµ¦ '+val.toFixed(1)+'</span>'; if(val>=7) return '<span class="flag high">å„ªå‹¢ '+val.toFixed(1)+'</span>'; return '<span class="flag mid">è§€ç…§ '+val.toFixed(1)+'</span>'; }

async function drawOracle(){
  try{ const res=await fetch('oracle_whispering.json'); const deck=await res.json(); const pick=deck[Math.floor(Math.random()*deck.length)];
    document.getElementById('oracleCard').innerHTML='<b>ã€Œ'+pick.title+'ã€</b><div class="hint">'+pick.poem+'</div><div class="pill"><b>è¡Œå‹•ï¼š</b>'+pick.action+'</div>'; }
  catch(e){ document.getElementById('oracleCard').textContent='æŠ½å¡è¼‰å…¥å¤±æ•—'; }
}

function saveStreak(){
  const key='e7_streak'; const today=new Date().toISOString().slice(0,10);
  let data = {last: null, streak: 0, list: []};
  try{ data = JSON.parse(localStorage.getItem(key)) || data; }catch(e){}
  if(data.last !== today){
    const yest = new Date(Date.now()-86400000).toISOString().slice(0,10);
    data.streak = (data.last===yest) ? (data.streak||0)+1 : 1;
    data.last = today;
    if(!data.list) data.list=[];
    if(!data.list.includes(today)) data.list.push(today);
    if(data.streak>=7) data.badge=true;
    localStorage.setItem(key, JSON.stringify(data));
  }
  updateStreakUI();
}

function updateStreakUI(){
  const key='e7_streak'; let data={streak:0,badge:false}; try{ data=JSON.parse(localStorage.getItem(key))||data; }catch(e){}
  const el=document.getElementById('streak');
  el.textContent = 'é€£çºŒ '+(data.streak||0)+' å¤©';
  if(data.badge) el.textContent += ' Â· ğŸ– ä¸ƒå…‰å¾½ç« ';
}

function renderResult(scores){
  drawRadar(scores);
  const entries=Object.entries(scores).sort((a,b)=>b[1]-a[1]);
  const top=entries[0], low=entries[entries.length-1];
  document.getElementById('topkeys').innerHTML = 'æœ€é«˜ï¼š'+top[0]+' '+top[1].toFixed(1)+' ï¼ æœ€ä½ï¼š'+low[0]+' '+low[1].toFixed(1);
  // Build phase details
  const ph=document.getElementById('phases'); ph.innerHTML='';
  const detailEls=[];
  for(const name of PHASES){
    const v=scores[name]; const info=PHASE_INFO[name];
    let advice=''; if(v<=3) advice=`ç‹€æ…‹åä½ ${flag(v)}ã€‚å»ºè­°ï¼š${info.actions[0]}ã€‚æ¨è–¦è¤‡æ–¹ï¼š${info.yl.slice(0,2).join('ã€')}ã€‚`;
    else if(v<=6) advice=`ä¸­ç­‰ ${flag(v)}ã€‚ç¶­æŒç¯€å¥ï¼š${info.actions[1]}ã€‚å–®æ–¹å¯è©¦ï¼š${info.single.join('ã€')}ã€‚`;
    else advice=`ç‹€æ…‹è‰¯å¥½ ${flag(v)}ã€‚æ“´å±•ï¼š${info.actions[2]}ã€‚`;
    const d=document.createElement('details');
    d.innerHTML='<summary>'+name+flag(v)+'</summary><div class="pill"><b>é—œéµå­—</b>ï¼š'+info.key+'</div><div class="pill"><b>å‹•æ…‹è§£è®€</b>ï¼š'+advice+'</div>';
    ph.appendChild(d); detailEls.push([name,d]);
  }
  // auto-expand lowest phase card
  const match = detailEls.find(x=>x[0]===low[0]); if(match){ match[1].open=true; match[1].scrollIntoView({behavior:'smooth',block:'center'}); }
}

document.getElementById('gen').addEventListener('click', async ()=>{
  const scores=computeScores(); renderResult(scores);
  try{ const res=await fetch('yl_blends.json'); const list=await res.json(); const pick=list[Math.floor(Math.random()*list.length)];
    document.getElementById('dailyOil').innerHTML='ä»Šæ—¥å»ºè­°ç²¾æ²¹ï¼š<b>'+pick.name+'ï¼ˆ'+pick.zh_name+'ï¼‰</b> <span class="hint">'+(pick.description||'')+'</span>'; }catch(e){}
  await drawOracle();
  saveStreak();
});

document.getElementById('draw').addEventListener('click', drawOracle);

if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js'); }
updateStreakUI();
</script>
</body>
</html>
